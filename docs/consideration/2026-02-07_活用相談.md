# VM内でのClaude Code運用に関する検討事項

## 1. 推奨ディレクトリ構造

### 1.1 基本方針

VM内でClaude Codeを動かす際は、**ホームディレクトリ配下にプロジェクト用のディレクトリを作成**することを推奨します。

### 1.2 推奨ディレクトリ構造

```
/home/USERNAME/
├── projects/                    # すべてのプロジェクトを管理する親ディレクトリ
│   ├── repo-name-1/            # リポジトリ1
│   │   ├── .git/
│   │   ├── src/
│   │   ├── README.md
│   │   └── ...
│   ├── repo-name-2/            # リポジトリ2
│   │   └── ...
│   └── repo-name-3/            # リポジトリ3
│       └── ...
├── .claude/                    # Claude Codeの設定・履歴（自動生成）
└── .bashrc / .zshrc           # シェル設定
```

### 1.3 具体的なパス例

Ubuntu環境の場合、デフォルトユーザーは通常 `ubuntu` または `gce-user` などです。

**推奨パス:**
```bash
/home/ubuntu/projects/
```

または、より明確に：
```bash
/home/ubuntu/workspace/
/home/ubuntu/repos/
```

### 1.4 ディレクトリ作成手順

VMにSSH接続後、以下のコマンドでディレクトリ構造を作成：

```bash
# プロジェクト用ディレクトリを作成
mkdir -p ~/projects

# 環境変数に追加（オプション）
echo 'export PROJECTS_DIR="$HOME/projects"' >> ~/.bashrc
source ~/.bashrc

# 新しいリポジトリをクローンする例
cd ~/projects
git clone https://github.com/USERNAME/REPO_NAME.git
cd REPO_NAME
```

### 1.5 リポジトリ単位での運用

各リポジトリは独立したディレクトリとして管理します：

```bash
~/projects/
├── my-web-app/          # Webアプリケーション
├── api-server/          # APIサーバー
├── cli-tool/            # CLIツール
└── documentation/       # ドキュメントプロジェクト
```

**メリット:**
- 各リポジトリが独立して管理できる
- パスが明確で、Claude Codeが理解しやすい
- 複数のプロジェクトを同時に扱いやすい
- Git操作がシンプル

### 1.6 代替案：/opt や /srv の使用

システム全体で共有する場合や、より「本番環境」に近い構成にしたい場合：

```bash
/opt/projects/           # オプショナルソフトウェア用
/srv/projects/           # サービス用データ
```

ただし、**ホームディレクトリ配下（`~/projects/`）を推奨**する理由：
- パーミッション管理が簡単
- ユーザー単位で管理できる
- バックアップが容易
- 一般的な開発環境の慣習に合致

## 2. ブラウザでの確認方法

VMローカルで実装されたものをブラウザで確認する方法は、以下の3つの方法があります。

### 2.1 方法1: SSHポートフォワーディング（推奨・最も安全）

**概要:** SSHトンネルを使って、ローカルマシン経由でVM内のサービスにアクセスします。

**手順:**

1. **SSH接続時にポートフォワーディングを設定**
   ```bash
   # ローカルマシン（MacBook）から実行
   gcloud compute ssh claude-code-vm \
     --zone=asia-northeast1-a \
     --project=gce-for-claude-code \
     --ssh-flag="-L 8080:localhost:8080"
   ```
   
   - `-L 8080:localhost:8080`: ローカルの8080ポートをVM内の8080ポートに転送
   - VM内で8080ポートでサービスを起動すると、ローカルの `http://localhost:8080` でアクセス可能

2. **VM内でサービスを起動**
   ```bash
   # VM内で実行
   cd ~/projects/my-web-app
   npm start  # または python -m http.server 8080 など
   ```

3. **ローカルブラウザでアクセス**
   - `http://localhost:8080` にアクセス

**メリット:**
- ファイアウォールルールを変更する必要がない（最も安全）
- 外部から直接アクセスできない
- 設定が簡単

**デメリット:**
- SSH接続が切れるとアクセスできなくなる
- 複数のポートを同時に転送する場合は設定が複雑

### 2.2 方法2: ファイアウォールルールでポートを開放（直接アクセス）

**概要:** GCPのファイアウォールルールで特定のポートを開放し、外部IP経由で直接アクセスします。

**手順:**

1. **ファイアウォールルールを作成**
   ```bash
   # ローカルマシンから実行
   gcloud compute firewall-rules create allow-http-dev \
     --allow tcp:8080 \
     --source-ranges 0.0.0.0/0 \
     --description "Allow HTTP for development"
   ```

2. **VM内でサービスを起動**
   ```bash
   # VM内で実行
   cd ~/projects/my-web-app
   npm start -- --host 0.0.0.0 --port 8080
   ```

3. **外部IPでアクセス**
   - VMの外部IPを確認: `gcloud compute instances describe claude-code-vm --zone=asia-northeast1-a --format="get(networkInterfaces[0].accessConfigs[0].natIP)"`
   - ブラウザで `http://EXTERNAL_IP:8080` にアクセス

**メリット:**
- SSH接続を維持する必要がない
- 複数のデバイスからアクセス可能

**デメリット:**
- セキュリティリスクが高い（開発環境のみ推奨）
- ファイアウォールルールの管理が必要

**セキュリティ強化案:**
```bash
# 特定のIPアドレスのみ許可
gcloud compute firewall-rules create allow-http-dev-restricted \
  --allow tcp:8080 \
  --source-ranges YOUR_IP_ADDRESS/32 \
  --description "Allow HTTP for development from specific IP"
```

### 2.3 方法3: Cloud Load Balancer / Cloud Run（本番環境向け）

**概要:** 本番環境やより堅牢な構成が必要な場合に使用します。

**Cloud Runの場合:**
- コンテナ化されたアプリケーションをデプロイ
- 自動スケーリング、HTTPS対応
- 詳細は `docs/consideration/initial.md` を参照

**Cloud Load Balancerの場合:**
- VMインスタンスの前にロードバランサーを配置
- HTTPS終端、SSL証明書の管理が可能

**注意:** 開発・検証段階では方法1（SSHポートフォワーディング）が最も適しています。

## 3. 実践例：Webアプリケーションの開発フロー

### 3.1 セットアップ

```bash
# VMにSSH接続（ポートフォワーディング付き）
gcloud compute ssh claude-code-vm \
  --zone=asia-northeast1-a \
  --project=gce-for-claude-code \
  --ssh-flag="-L 3000:localhost:3000" \
  --ssh-flag="-L 8080:localhost:8080"
```

### 3.2 プロジェクトのクローンと起動

```bash
# VM内で実行
cd ~/projects
git clone https://github.com/USERNAME/my-web-app.git
cd my-web-app
npm install
npm start  # ポート3000で起動
```

### 3.3 ブラウザで確認

- ローカルマシンのブラウザで `http://localhost:3000` にアクセス

### 3.4 開発サイクル

1. **VM内でClaude Codeが実装**
   - `~/projects/my-web-app/` で作業
   - 変更をコミット・プッシュ

2. **ローカルでレビュー**
   - MacBookで `git pull`
   - 必要に応じて修正

3. **VM内で再確認**
   - SSH接続を維持したまま、VM内でサービスを再起動
   - ブラウザで確認

## 4. Claude Codeの認証手順

VM内でClaude Codeを使用するには、認証が必要です。以下の手順で認証を行ってください。

### 4.1 認証前の準備

1. **Claude Consoleアカウントの準備**
   - Claude Console（https://console.claude.com）にアクセス
   - アカウントを作成またはログイン
   - 必要に応じて、チーム管理者から「Claude Code」または「Developer」ロールの招待を受ける

2. **SSH接続（ポートフォワーディング推奨）**
   - ブラウザ認証を使用する場合、SSHポートフォワーディングが必要です

### 4.2 認証方法

#### 方法1: ブラウザ認証（推奨）

```bash
# VM内で実行
claude auth login
# または
claude login
```

認証URLが表示されるので、SSHポートフォワーディングを使用している場合、ローカルマシンのブラウザでアクセスして認証を完了します。

#### 方法2: APIキーを使用

```bash
# Claude ConsoleでAPIキーを生成後、環境変数に設定
export ANTHROPIC_API_KEY="your-api-key-here"

# 永続化
echo 'export ANTHROPIC_API_KEY="your-api-key-here"' >> ~/.bashrc
source ~/.bashrc
```

**セキュリティ注意事項：**
- APIキーは機密情報です。`.gitignore`に追加し、リポジトリにコミットしないでください
- 可能であれば、GCP Secret Managerを使用して安全に管理してください

### 4.3 認証の確認

```bash
# 認証状態の確認
claude auth status
# または
claude whoami

# 動作確認
claude "Hello, this is a test message."
```

### 4.4 トラブルシューティング

認証に失敗する場合：

```bash
# 認証をリセット
claude auth logout

# 再認証
claude auth login

# 環境変数を確認（APIキー使用時）
echo $ANTHROPIC_API_KEY
```

詳細な手順は `docs/todo/INSTANCE_SETUP_GUIDE.md` の「4. Claude Codeの認証」セクションを参照してください。

## 5. VMのコスト削減戦略

VMの利用が一定期間ない場合（特にClaude Codeが動いていない場合）のコスト削減について、適切な実行方針を提案します。

### 5.1 基本方針：停止 vs スリープ

**Compute Engineには「スリープ」機能はありません。** 利用可能な選択肢は以下の通りです：

| 方法 | コスト削減 | データ保持 | 起動時間 | 推奨用途 |
|------|-----------|----------|---------|---------|
| **停止（Stop）** | ✅ 100%（CPU/メモリ） | ✅ 完全保持 | 約30秒〜1分 | **推奨** |
| **削除（Delete）** | ✅ 100%（すべて） | ❌ 削除される | 再作成が必要 | 不要時のみ |
| **実行中（Running）** | ❌ 0% | ✅ 完全保持 | 即座 | 使用中のみ |

**結論：停止（Stop）を推奨します。**

### 5.2 停止のメリット・デメリット

#### メリット
- **コスト削減：** CPU/メモリの料金が発生しない（ディスク料金のみ）
- **データ保持：** 永続ディスクのデータは完全に保持される
  - `~/.claude/` の履歴
  - `~/projects/` のプロジェクト
  - インストール済みのソフトウェア
- **起動が速い：** 約30秒〜1分で起動可能
- **外部IP保持：** 停止中も外部IPアドレスは保持される（エフェメラルIPの場合、再起動時に変わる可能性あり）

#### デメリット
- **起動が必要：** 使用前に起動コマンドを実行する必要がある
- **ディスク料金：** 停止中もディスク料金は発生（通常は月額数ドル程度）

### 5.3 推奨実行方針

#### 方針1: 手動停止（シンプル・推奨）

**使用パターン：**
- 定期的に使用するが、毎日ではない
- 使用前に起動、使用後に停止する習慣がある

**手順：**

```bash
# 使用開始時：インスタンスを起動
gcloud compute instances start claude-code-vm \
  --zone=asia-northeast1-a \
  --project=gce-for-claude-code

# 使用終了時：インスタンスを停止
gcloud compute instances stop claude-code-vm \
  --zone=asia-northeast1-a \
  --project=gce-for-claude-code
```

**コスト削減効果：**
- 1日8時間使用、16時間停止の場合：約67%削減
- 週末のみ使用の場合：約71%削減

#### 方針2: スケジュール停止（自動化・推奨）

**使用パターン：**
- 毎朝6時に自動停止したい
- 使用するときは手動で起動
- 夜中は停止しないが、朝6時には必ず停止する

**実装方法：Cloud Scheduler + Cloud Functions**

このリポジトリには、毎朝6時に自動停止する設定スクリプトが含まれています。

**手順：**

1. **Cloud Functionsをデプロイ**

```bash
# スクリプトに実行権限を付与（初回のみ）
chmod +x scripts/setup-functions.sh

# Cloud Functionをデプロイ
./scripts/setup-functions.sh -p YOUR_PROJECT_ID
```

2. **Cloud Schedulerを設定**

```bash
# スクリプトに実行権限を付与（初回のみ）
chmod +x scripts/setup-scheduler.sh

# 毎朝6時に自動停止するスケジュールを設定
./scripts/setup-scheduler.sh -p YOUR_PROJECT_ID
```

**設定内容：**
- **スケジュール:** 毎朝6時（JST、`0 6 * * *`）
- **タイムゾーン:** `Asia/Tokyo`
- **動作:** インスタンスを停止（既に停止している場合は何もしない）

**使用フロー：**

1. **使用開始時（手動）**
   ```bash
   ./scripts/vm-control.sh start
   ```

2. **使用中**
   - Claude Codeで作業
   - 夜中も使用可能（自動停止されない）

3. **毎朝6時（自動）**
   - Cloud Schedulerが自動的にインスタンスを停止
   - Claude Codeが動作していても停止される

4. **次回使用時（手動）**
   ```bash
   ./scripts/vm-control.sh start
   ```

**コスト削減効果：**
- 毎朝6時に停止、使用時のみ起動：使用時間に応じて67-90%削減
- 例：1日平均4時間使用の場合、約83%削減

**注意事項：**
- 停止前に必ず `git commit` と `git push` を実行することを推奨
- 朝6時時点で実行中の作業がある場合は、停止前に保存・コミットする

#### 方針3: 使用状況監視による自動停止（高度）

**使用パターン：**
- 使用時間が不規則
- Claude Codeの実行状況を監視して自動停止したい

**実装方法：VM内で監視スクリプトを実行**

```bash
# VM内で実行する監視スクリプト（例：check-claude-activity.sh）
#!/bin/bash
# Claude Codeのプロセスをチェック
if ! pgrep -f "claude" > /dev/null; then
    # 最後のClaude Code実行から30分経過しているかチェック
    LAST_ACTIVITY=$(find ~/.claude -type f -mmin -30 2>/dev/null | wc -l)
    if [ "$LAST_ACTIVITY" -eq 0 ]; then
        # 30分間活動がない場合、インスタンスを停止
        echo "Claude Codeが30分間使用されていません。インスタンスを停止します。"
        # メタデータサービス経由で停止（または外部APIを呼び出し）
        # 注意: インスタンス自身から停止するには、適切な権限が必要
    fi
fi
```

**注意：** この方法は、インスタンス自身から停止するため、適切な権限設定が必要です。より安全な方法は、外部の監視サービス（Cloud Monitoring + Cloud Functions）を使用することです。

### 5.4 実装例：シンプルな停止/起動スクリプト

ローカルマシンで使用する便利スクリプトを作成：

```bash
#!/bin/bash
# scripts/vm-control.sh

INSTANCE_NAME="claude-code-vm"
ZONE="asia-northeast1-a"
PROJECT_ID="gce-for-claude-code"

case "$1" in
    start)
        echo "インスタンスを起動しています..."
        gcloud compute instances start "$INSTANCE_NAME" \
          --zone="$ZONE" \
          --project="$PROJECT_ID"
        echo "起動完了。SSH接続まで少し待ってください。"
        ;;
    stop)
        echo "インスタンスを停止しています..."
        gcloud compute instances stop "$INSTANCE_NAME" \
          --zone="$ZONE" \
          --project="$PROJECT_ID"
        echo "停止完了。"
        ;;
    status)
        gcloud compute instances describe "$INSTANCE_NAME" \
          --zone="$ZONE" \
          --project="$PROJECT_ID" \
          --format="get(status)"
        ;;
    ssh)
        gcloud compute ssh "$INSTANCE_NAME" \
          --zone="$ZONE" \
          --project="$PROJECT_ID"
        ;;
    *)
        echo "使用方法: $0 {start|stop|status|ssh}"
        exit 1
        ;;
esac
```

**使用方法：**

```bash
chmod +x scripts/vm-control.sh

# 起動
./scripts/vm-control.sh start

# 停止
./scripts/vm-control.sh stop

# 状態確認
./scripts/vm-control.sh status

# SSH接続
./scripts/vm-control.sh ssh
```

### 5.5 コスト削減の効果試算

**前提条件：**
- マシンタイプ: `e2-standard-2` (2 vCPU, 8 GB RAM)
- リージョン: `asia-northeast1` (東京)
- ディスク: 50GB 標準永続ディスク

**月額コスト（概算）：**

| 運用パターン | 実行時間 | 月額コスト（概算） | 削減率 |
|------------|---------|-----------------|--------|
| 24時間365日稼働 | 730時間 | 約$50-60 | 0% |
| 平日9:00-18:00のみ | 180時間 | 約$15-20 | 約67% |
| 週末のみ使用 | 48時間 | 約$5-8 | 約87% |
| 使用時のみ起動（1日2時間） | 60時間 | 約$5-7 | 約90% |

**注意：** 上記は概算です。実際のコストは、リージョン、ディスクタイプ、ネットワーク使用量などによって異なります。

### 5.6 ベストプラクティス

#### 推奨運用フロー

1. **使用開始時**
   ```bash
   # インスタンスを起動
   ./scripts/vm-control.sh start
   
   # 起動を待つ（約30秒〜1分）
   sleep 60
   
   # SSH接続
   ./scripts/vm-control.sh ssh
   ```

2. **使用中**
   - Claude Codeで作業
   - 定期的に `git commit` を実行（データ損失防止）

3. **使用終了時**
   ```bash
   # VM内で実行中のプロセスを確認
   ps aux | grep claude
   
   # 必要に応じてプロセスを終了
   
   # ローカルマシンに戻って停止
   exit  # SSH接続を終了
   ./scripts/vm-control.sh stop
   ```

#### 注意事項

- **データの保存：** 停止前に必ず `git commit` と `git push` を実行
- **実行中のプロセス：** 停止前に実行中のClaude Codeプロセスを確認
- **外部IP：** エフェメラルIPを使用している場合、再起動時にIPが変わる可能性がある
- **起動時間：** 停止から起動まで約30秒〜1分かかることを考慮

### 5.7 まとめ：推奨方針

**推奨：毎朝6時の自動停止 + 手動起動（方針2）**

- ✅ 毎朝6時に自動停止（忘れ防止）
- ✅ 使用時は手動で起動（柔軟性）
- ✅ 夜中も使用可能（朝6時まで）
- ✅ コスト削減効果が高い（使用時間に応じて67-90%削減可能）
- ✅ データは完全に保持される
- ✅ 起動が速い（約30秒〜1分）

**実装方法：**
```bash
# 1. Cloud Functionsをデプロイ
./scripts/setup-functions.sh -p YOUR_PROJECT_ID

# 2. Cloud Schedulerを設定（毎朝6時）
./scripts/setup-scheduler.sh -p YOUR_PROJECT_ID

# 3. 使用時は手動で起動
./scripts/vm-control.sh start
```

**手動停止のみの場合（方針1）**

- ✅ 実装が簡単（スクリプト不要）
- ✅ 完全に手動制御
- ✅ コスト削減効果が高い

**結論：**
- **毎朝6時に自動停止したい場合：スケジュール停止（方針2）を推奨**
- **完全に手動で管理したい場合：手動停止（方針1）**
- **常時使用する場合：停止は不要（コスト削減効果が低い）**

## 6. まとめ

### 推奨ディレクトリ構造
- **基本パス:** `~/projects/` または `~/workspace/`
- **各リポジトリ:** `~/projects/REPO_NAME/` として独立管理

### ブラウザ確認方法
- **開発・検証:** SSHポートフォワーディング（方法1）を推奨
- **一時的な共有:** ファイアウォールルールでポート開放（方法2）
- **本番環境:** Cloud Load Balancer / Cloud Run（方法3）

### Claude Code認証
- **推奨方法:** ブラウザ認証（`claude auth login`）
- **代替方法:** APIキーを環境変数に設定
- **セキュリティ:** APIキーはSecret Managerで管理、リポジトリにコミットしない

### セキュリティのベストプラクティス
- 開発中はSSHポートフォワーディングを使用
- ポートを開放する場合は、可能な限り特定IPのみ許可
- 本番環境では必ずHTTPSを使用
- APIキーなどの認証情報は適切に管理

